<div class="ov-form">
  <!-- Título principal del formulario -->
  <h2>Orden de Venta</h2>
  <!-- Formulario principal, ejecuta guardarOV al enviar -->
  <form (submit)="guardarOV(); $event.preventDefault()">
    <!-- Sección de cabecera con los datos principales de la OV -->
    <fieldset>
      <legend>Cabecera</legend>
      <label>
        Código de Cliente:
        <input type="text" [value]="clienteCodigo()" (input)="clienteCodigo.set($event.target.value)" required />
      </label>
      <label>
        Documento (RUC/DNI):
        <input type="text" [value]="documento()" (input)="documento.set($event.target.value)" required />
      </label>
      <label>
        Nombre de Cliente:
        <input type="text" [value]="clienteNombre()" (input)="clienteNombre.set($event.target.value)" required />
      </label>
      <label>
        Correlativo:
        <!-- Solo lectura, autogenerado -->
        <input type="text" [value]="correlativo()" readonly />
      </label>
      <label>
        Fecha OV:
        <!-- Campo reactivo, inicializado con la fecha actual -->
        <input type="date" [value]="fechaOV()" (input)="fechaOV.set($event.target.value)" required />
      </label>
      <label>
        Dirección de Envío:
        <!-- Campo reactivo, actualiza la señal direccionEnvio -->
        <input type="text" [value]="direccionEnvio()" (input)="direccionEnvio.set($event.target.value)" required />
      </label>
    </fieldset>

    <!-- Sección de detalle, permite agregar productos a la OV -->
    <fieldset>
      <legend>Detalle</legend>
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Recorre cada línea del detalle usando *ngFor -->
          <tr *ngFor="let item of detalle(); let i = index">
            <td>
              <!-- Campo reactivo para el código del producto -->
              <input type="text" [value]="item.codigo" (input)="actualizarDetalle(i, 'codigo', $event.target.value)" required />
            </td>
            <td>
              <!-- Campo reactivo para la descripción -->
              <input type="text" [value]="item.descripcion" (input)="actualizarDetalle(i, 'descripcion', $event.target.value)" required />
            </td>
            <td>
              <!-- Campo reactivo para el precio unitario -->
              <input type="number" min="0" step="0.01" [value]="item.precioUnitario" (input)="actualizarDetalle(i, 'precioUnitario', +$event.target.value)" required />
            </td>
            <td>
              <!-- Campo reactivo para la cantidad -->
              <input type="number" min="1" step="1" [value]="item.cantidad" (input)="actualizarDetalle(i, 'cantidad', +$event.target.value)" required />
            </td>
            <td>
              <!-- Subtotal calculado automáticamente -->
              {{ item.subtotal | number:'1.2-2' }}
            </td>
            <td>
              <!-- Botón para eliminar la línea del detalle -->
              <button type="button" (click)="eliminarDetalle(i)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Botón para agregar una nueva línea al detalle -->
      <button type="button" (click)="agregarDetalle()">Agregar línea</button>
    </fieldset>

    <!-- Muestra el total calculado de la OV -->
    <div class="ov-total">
      <strong>Total: </strong>{{ total() | number:'1.2-2' }}
    </div>

    <!-- Botón para guardar la OV -->
    <button type="submit">Guardar OV</button>
  </form>

  <!-- Popup que muestra el JSON generado al guardar la OV -->
  <div class="popup" *ngIf="mostrarPopup()">
    <div class="popup-content">
      <h3>JSON a enviar</h3>
      <pre>{{ jsonOV() }}</pre>
      <button type="button" (click)="cerrarPopup()">Cerrar</button>
    </div>
  </div>
</div>
